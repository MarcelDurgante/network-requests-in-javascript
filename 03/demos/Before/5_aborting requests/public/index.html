<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <link rel="icon" href="img/favicon.ico" />
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/styles.css">
    <script src="js/helpers.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Globoticket</title>
</head>

<body>
    <div id="root">
        <nav class="navbar navbar-expand navbar-dark fixed-top bg-dark">
            <div class="container-fluid">
                <div class="collapse navbar-collapse">
                    <ul class="navbar-nav me-auto ms-3 mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a href="./" class="navbar-brand"><img src="img/logo.png" alt="Globoticket logo" /></a>
                        </li>
                    </ul>
                </div>
                <div class="collapse navbar-collapse">
                    <ul class="navbar-nav ms-auto me-5 mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a href="./cart" class="nav-link">
                                <span class="bi bi-cart-plus-fill text-white font-xxlarge"></span>
                                <span class="font-upper font-bold text-white ms-4">
                                    <span class="font-xxlarge align-middle" id="spanTickets">0</span>
                                    <span class="align-middle ms-2">ticket(s)</span>
                                </span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <div class="container" id="eventtable">
            <div class="container">
                <table class="table mt-5">
                    <thead>
                        <tr>
                            <th scope="col"></th>
                            <th scope="col">Date</th>
                            <th scope="col">Name</th>
                            <th scope="col">Artist</th>
                            <th scope="col">Price</th>
                            <th scope="col"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="align-middle">
                            <td>
                                <img class="img-fluid max-100" src="img/logos/Container-Enthusiasm-TalkDocker-To-Me.png"
                                    alt="Cover" />
                            </td>
                            <td class="max-50">
                                10/1/2025, 7:00:00 PM
                            </td>
                            <td class="max-50">
                                Talk Docker to Me Tour
                            </td>
                            <td class="max-50">
                                Container Enthusiasm
                            </td>
                            <td class="max-50">
                                $49.99
                            </td>
                            <td class="max-50">
                                <button type="button" class="btn btn-primary btn-primary-themed btn-md font-upper"
                                    onclick="document.getElementById('spanTickets').innerHTML = ++(document.getElementById('spanTickets').innerHTML)">Add
                                    to Cart</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        /* Aborting requests: 
        
        When a request is long‑running, we may wish to abort it. The Fetch API does support that. There are just two additional objects we need to know because then we can implement this feature. 
        
            - First of all, we need a so‑called AbortController. That's the object that essentially takes care about aborting a request, but that's not enough. 
            - We also need something called a signal. Signal is a property of the AbortController, and that signal then will be used to communicate with the fetch call. 
        
        So we have the AbortController, we have the fetch call, and we have the signal basically standing in between as a means of communication. And what we then do is pretty straightforward. 
        
        We do our fetch call with the URL, and we also might have some properties like the HTTP method, HTTP headers, payload, etc. And we also provide the signal. 
        
        So, signal on the left is the key, signal on the right is the variable we just created. 
        
        Then the fetch call is running. And if it runs too long, we have the signal assigned to the request, which basically binds the controller to the request. 
        
        And then at any time, we can call the abort method of the controller. And thanks to the signal being tied to the controller and the signal also being tied to the fetch call, this essentially aborts the request. 

        const controller = new AbortController();              <- Object for aborting the request
        const signal = controller.signal;                      <- Object for communicating with the requests
        fetch(url, { signal: signal });                        <- Assign signal (and controller) to the request
        controller.abort();                                    <- Abort request
        

        Let's implement that in our application. I have changed the application a little bit in order to be able to demonstrate that feature and to put it to good use. As you can see here, the covers or the images for the events, they are gone. So far, to be honest, I've been cheating. Those covers, they did not come from the API. They were static assets of the web application. I've changed this, and now we can put the AbortController to good use. Let's update the code. First of all, we need to make sure that we're using the stable events endpoints so that we don't get that many errors. And now I'd like to implement a little bit once we get events from the API. 

        First of all, I create a variable, controllers, where I store all the AbortControllers because I'm now loading a couple of images, and there will be an AbortController for each of those so they can abort all of these requests because maybe they take some time. I got the events, which I'm showing, and then I iterate over the events because for each event, I'll need to make sure that an image appears. How do I do that? Well, I have an extra endpoint, api/cover/, and then I just provide the ID of the event, and that returns basically the image. So far, so good. And then I get some response back, and I handled this text this time because it could be binary data since its images, but I'm actually encoding them. And then I get an image, and then I have a helper function, showImage, which basically shows an image for an event.id. And if something goes wrong, I could still log the exception
        */

        let controllers = []; // 1. create a variable, controllers, where I store all the AbortControllers
        fetch('api/events') // 2. using the stable events endpoints
            .then(response => {
                if (response.status !== 200) {
                    showError('Something went wrong.');
                }
                return response.json();
            })
            .then(events => {
                showEvents(events); // 3. we got the events, which we are showing
                events.forEach(event => { // iterate over the events because for each event, I'll need to make sure that an image appears
                    fetch(`api/cover/${event.id}`) //  extra endpoint, api/cover/, and then I just provide the ID of the event, and that returns basically the image
                        .then(response => response.text()) // response back, and I handled this text this time because it could be binary data since its images
                        .then(img => showImage(img, event.id)) // get an image, and then I have a helper function, showImage, which basically shows an image for an event.id
                        .catch((execption) => console.log(execption)) // if something goes wrong, I could still log the exception
                });
            });

            /* output 1: 
            
            All right, so far, so good, I've already created that controllers array as well, but we are not aborting yet. Let me show you in the application. 
            
            I reload, and then you see that one image appears. And well, it takes some time, but eventually they are there. 
            
            I could go to the browser DevTools, and then I can activate throttling so that it's even a little bit slower. So, how about we use maybe Good 3G, or let's use Regular 4G/LTE, then it takes even a little bit longer.
            
            And I'd like to use that and use that opportunity to be able to eventually abort that loading of those images here because it just takes too long, and I can implement that in our code.
            
            */

        function addToCart(id, quantity) {
            fetch('api/cart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: id, quantity: quantity })
            })
                .then(response => {
                    if (response.status === 200) {
                        fetch('api/cart')
                            .then(response => response.json())
                            .then(cart => updateCart(cart));
                    }
                });
        }
    </script>
</body>

</html>