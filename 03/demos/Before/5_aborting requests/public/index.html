<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <link rel="icon" href="img/favicon.ico" />
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/styles.css">
    <script src="js/helpers.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Globoticket</title>
</head>

<body>
    <div id="root">
        <nav class="navbar navbar-expand navbar-dark fixed-top bg-dark">
            <div class="container-fluid">
                <div class="collapse navbar-collapse">
                    <ul class="navbar-nav me-auto ms-3 mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a href="./" class="navbar-brand"><img src="img/logo.png" alt="Globoticket logo" /></a>
                        </li>
                    </ul>
                </div>
                <div class="collapse navbar-collapse">
                    <ul class="navbar-nav ms-auto me-5 mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a href="./cart" class="nav-link">
                                <span class="bi bi-cart-plus-fill text-white font-xxlarge"></span>
                                <span class="font-upper font-bold text-white ms-4">
                                    <span class="font-xxlarge align-middle" id="spanTickets">0</span>
                                    <span class="align-middle ms-2">ticket(s)</span>
                                </span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <div class="container" id="eventtable">
            <div class="container">
                <table class="table mt-5">
                    <thead>
                        <tr>
                            <th scope="col"></th>
                            <th scope="col">Date</th>
                            <th scope="col">Name</th>
                            <th scope="col">Artist</th>
                            <th scope="col">Price</th>
                            <th scope="col"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="align-middle">
                            <td>
                                <img class="img-fluid max-100" src="img/logos/Container-Enthusiasm-TalkDocker-To-Me.png"
                                    alt="Cover" />
                            </td>
                            <td class="max-50">
                                10/1/2025, 7:00:00 PM
                            </td>
                            <td class="max-50">
                                Talk Docker to Me Tour
                            </td>
                            <td class="max-50">
                                Container Enthusiasm
                            </td>
                            <td class="max-50">
                                $49.99
                            </td>
                            <td class="max-50">
                                <button type="button" class="btn btn-primary btn-primary-themed btn-md font-upper"
                                    onclick="document.getElementById('spanTickets').innerHTML = ++(document.getElementById('spanTickets').innerHTML)">Add
                                    to Cart</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        /* output: 
        
        CORS or "cross-origin resource sharing" is a security feature of JavaScript. CORS is important to understand because it can have implications for your code. Let's break it down:

            - When a client application on a website like app.example.com sends a request to an API on a different website, it's considered a cross-origin request because the origins (protocol, domain, and port) are different.

            - By default, JavaScript cannot access the response from a cross-origin request. This is a security measure to protect against potential attacks.

            - CORS can sometimes be cumbersome (complicated/annoying) when working with APIs on different origins, but it serves an important purpose in protecting web applications.

            - However, there are cases where you may need to access the response from a cross-origin request. In such cases, the server (API) can allow access by sending the Access-Control-Allow-Origin header, which specifies the allowed origin (client application).

            - For POST requests or other requests that change the state of the application, the browser first sends a preflighted OPTIONS request to check if the server allows the cross-origin request.

            - The server can respond with the Access-Control-Allow-Origin header and other headers to indicate which methods and headers are allowed for the cross-origin request.

            - Without the Access-Control-Allow-Origin header, the browser will not send the POST request. This is something that needs to be configured on the server side.

            - If you encounter errors related to cross-origin requests or missing CORS headers in your browser console, it means there are configuration issues on the server/API side.

            - In addition to understanding fetch, we will also explore another popular library called Axios, which simplifies sending HTTP requests from JavaScript code.

            See example:

                                fetch('https://api.example.com/data')
                                .then(response => {
                                    // Check if the response status is OK (200)
                                    if (response.ok) {
                                    // Check if the server allows the client application's origin
                                    const allowedOrigin = response.headers.get('Access-Control-Allow-Origin');
                                    const clientOrigin = 'https://app.example.com';

                                    if (allowedOrigin === clientOrigin || allowedOrigin === '*') {
                                        // If the server allows the client application's origin, parse the response data
                                        return response.json();
                                    } else {
                                        // If the server does not allow the client application's origin, throw an error
                                        throw new Error('Server does not allow cross-origin requests from this origin');
                                    }
                                    } else {
                                    // If the response status is not OK, throw an error
                                    throw new Error(`Request failed with status ${response.status}`);
                                    }
                                })
                                .then(data => {
                                    // Handle the response data here
                                    console.log(data);
                                })
                                .catch(error => {
                                    // Handle any errors that occurred during the request
                                    console.error(error);
                                });
        
        */
        let controllers = [];
        fetch('api/events')
            .then(response => {
                if (response.status !== 200) {
                    showError('Something went wrong.');
                }
                return response.json();
            })
            .then(events => {
                showEvents(events);
                events.forEach(async event => {
                    let controller = new AbortController();
                    controllers.push(controller);
                    const response = await fetch(`api/cover/${event.id}`, {
                        signal: controller.signal,
                    });
                    const reader = response.body.getReader();
                    const total = response.headers.get('Content-Length') || 0;
                    let chunks = [];
                    let received = 0;
                    while (true) {
                        const { done, value } = await reader.read();
                        if (value) {
                            chunks.push(value);
                            received += value.length;
                            showProgress(total === 0 ? 'N/A' : Math.ceil(100 * received / total) + '%', event.id);
                        }
                        if (done) break;
                    }
                    removeProgress(event.id);
                    var img = decodeChunks(chunks);
                    showImage(img, event.id);
                });
            });

        function abort() {
            controllers.forEach(controller => controller.abort());
        }

        function addToCart(id, quantity) {
            fetch('api/cart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: id, quantity: quantity })
            })
                .then(response => {
                    if (response.status === 200) {
                        fetch('api/cart')
                            .then(response => response.json())
                            .then(cart => updateCart(cart));
                    }
                });
        }
    </script>
</body>

</html>