<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <link rel="icon" href="img/favicon.ico" />
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://unpkg.com/axios@1.4.0/dist/axios.min.js"></script>
    <script src="js/helpers.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Globoticket</title>
</head>

<body>
    <div id="root">
        <nav class="navbar navbar-expand navbar-dark fixed-top bg-dark">
            <div class="container-fluid">
                <div class="collapse navbar-collapse">
                    <ul class="navbar-nav me-auto ms-3 mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a href="./" class="navbar-brand"><img src="img/logo.png" alt="Globoticket logo" /></a>
                        </li>
                    </ul>
                </div>
                <div class="collapse navbar-collapse">
                    <ul class="navbar-nav ms-auto me-5 mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a href="./cart" class="nav-link">
                                <span class="bi bi-cart-plus-fill text-white font-xxlarge"></span>
                                <span class="font-upper font-bold text-white ms-4">
                                    <span class="font-xxlarge align-middle" id="spanTickets">0</span>
                                    <span class="align-middle ms-2">ticket(s)</span>
                                </span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <div class="container" id="eventtable">
            <div class="container">
                <table class="table mt-5">
                    <thead>
                        <tr>
                            <th scope="col"></th>
                            <th scope="col">Date</th>
                            <th scope="col">Name</th>
                            <th scope="col">Artist</th>
                            <th scope="col">Price</th>
                            <th scope="col"></th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        //  add the download progress tracking feature to our Globoticket application
        axios.get('api/events') //  switch back from eventâ€‘brittle to events
        //  handle the response properly. 
            .then(response => { // So far, were only showing the events, but we now also would like to load the associated images and then track that download. So, we are introducing a code block here. 
                const events = response.data; // // First of all, I'm introducing the events variable, which holds the data from that API call because I need the events twice.
                showEvents(events); // The first time I need it here for the showEvents call
                events.forEach(event => { // and then I need to iterate over all of them. And for each event, I have to load the associated image and do the tracking
                    axios({ // To implement, we are calling the axios function
                        method: 'GET', //  and configure it to use HTTP GET. Yes, that's the default. But still, I would like things to be readable and explicit. So, I'll just state that here.  
                        url: `api/cover/${event.id}`, // And the URL is api/cover and then the event.id. 
                        // And the new feature we just talked about is an event handler for the download progress event. And that event handler can then be used to show how much data has already been transferred. 
                        onDownloadProgress: (e) => showProgress( // We've already implemented a helper function, showProgress, which interacts with the UI, and that showProgress helper needs the value to display and where to display it. Now the value to display is something we could read out of the progress property of the event arguments. The progress property contains a value between 0 and 1 if and only if we have the total length of bytes we expect. So that's basically when the content length HTTP response header is set. If not, that value here is not available, so this could be the case. So we have to check whether there's anything useful in it. 
                            e.progress ? Math.round(100 * e.progress) + '%' : 'N/A', // And if so, we can just do something like this, Math.round, and then we round 100 times that value and output it with a percentage sign. Otherwise, we just say not available.
                            // We can't really say how many percent or what fraction of the data has already been transferred if you don't know the total number we expect. So that's the what, and the where is the event.id, and then our helper function basically takes care of the rest. So that is the call that retrieves the image. The progress will be updated. And once we get a result, then we have our image.
                            event.id
                        )
                    })
                        .then(response => { // So, we look at our response. 
                            removeProgress(event.id); // We can then remove the progress information for that event.id. 
                            showImage(response.data, event.id) // And finally, we call showImage, which then shows or adds the image to the UI for said event. All of these helper functions are functions, which I have already implemented that update the UI, which is beyond the scope of this course. So this just works out of the box because
                        })
                });
            })
            .catch(error => {
                if (error.response) {
                    showError(JSON.stringify(error.response.data));
                } else {
                    showError('Something went wrong')
                }
            })

        function addToCart(id, quantity) {
            axios({
                method: 'POST',
                url: 'api/cart',
                headers: {
                    'Content-Type': 'application/json'
                },
                data: {
                    id: id,
                    quantity: quantity
                }
            })
                .then(response => {
                    if (response.status === 200) {
                        axios({
                            method: 'GET',
                            url: 'api/cart'
                        })
                            .then(response => updateCart(response.data))
                    }
                })
        }
    </script>
</body>

</html>